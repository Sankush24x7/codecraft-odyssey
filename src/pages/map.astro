---
import BaseLayout from '../layouts/BaseLayout.astro';
import '../styles/pixel-theme.css';
---

<BaseLayout title="World Map - CodeCraft Odyssey">
  <div class="theme-pixel scanlines pixel-grid-bg" style="min-height: 100vh; padding: 20px;">
    
    <!-- Header -->
    <header style="max-width: 1200px; margin: 0 auto 32px; padding: 20px; background: var(--pixel-surface); border: 4px solid var(--pixel-border);">
      <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
        
        <!-- Player Info -->
        <div>
          <h1 class="mission-title" style="font-size: 18px; margin-bottom: 8px;">
            <span id="playerName">Adventurer</span>
          </h1>
          <div class="health-display">
            <span style="color: var(--pixel-accent);">HP:</span>
            <div id="healthContainer"></div>
          </div>
        </div>

        <!-- XP Progress -->
        <div style="flex: 1; min-width: 250px; max-width: 400px;">
          <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-family: var(--font-pixel); font-size: 10px;">
            <span style="color: var(--pixel-accent);">LEVEL <span id="currentLevel">1</span></span>
            <span id="xpProgress">0 / 200 XP</span>
          </div>
          <div class="xp-bar">
            <div class="xp-fill" id="xpFill" style="width: 0%;"></div>
            <div class="xp-text" id="xpPercent">0%</div>
          </div>
        </div>

        <!-- Stats -->
        <div style="text-align: right; font-size: 16px;">
          <div>üèÜ <span id="badgeCount">0</span> Badges</div>
          <div>‚úÖ <span id="completedCount">0</span> Missions</div>
        </div>

        <!-- Skill World Button -->
        <div style="display:flex; align-items:center; gap:8px;">
          <button id="skillWorldBtn" class="pixel-button" style="padding:10px 12px; font-size:14px;">üéØ Skill World</button>
        </div>

      </div>
    </header>

    <!-- World 1: Novice Plains -->
    <main style="max-width: 1200px; margin: 0 auto;">
      
      <div class="pixel-card">
        <h2 class="mission-title" style="margin-bottom: 24px;">
          üå± WORLD 1: NOVICE PLAINS
        </h2>
        <p style="font-size: 18px; margin-bottom: 24px; color: var(--pixel-text-dim);">
          Master the fundamentals. Fix bugs, debug code, and learn the basics of programming!
        </p>

        <!-- Level Grid -->
        <div id="levelGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 16px;">
          <!-- Levels will be dynamically inserted here -->
        </div>
      </div>

      <!-- Coming Soon Worlds -->
      <div class="pixel-card" style="margin-top: 24px; opacity: 0.6;">
        <h3 style="font-family: var(--font-pixel); font-size: 14px; margin-bottom: 16px; color: var(--pixel-text-dim);">
          üîí COMING SOON
        </h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; font-size: 16px;">
          <div>üèóÔ∏è API Citadel (16-30)</div>
          <div>üé® Frontend Kingdom (31-50)</div>
          <div>üîê Security Fortress (51-65)</div>
          <div>‚öôÔ∏è Performance Arena (66-85)</div>
          <div>üß† Architect Summit (86-100)</div>
        </div>
      </div>

    </main>

    <!-- Skill World Modal (hidden by default) -->
    <div id="skillWorldModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); align-items:center; justify-content:center; z-index:9999;">
      <div style="background:var(--pixel-surface); border:4px solid var(--pixel-border); max-width:900px; width:95%; max-height:80vh; overflow:auto; padding:20px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
          <h3 style="margin:0; font-family:var(--font-pixel);">üéØ Skill World ‚Äî Worlds Overview</h3>
          <button id="closeSkillModal" class="pixel-button">Close</button>
        </div>

        <div id="skillWorldContent">
          <p style="color:var(--pixel-text-dim); margin:0 0 12px 0;">Loading worlds...</p>
        </div>
      </div>
    </div>

  </div>

  <script>
    import { getGameState } from '../scripts/gameState.js';

    const gameState = getGameState();
    const state = gameState.get();

    // Update header
    document.getElementById('playerName').textContent = state.playerName;
    document.getElementById('currentLevel').textContent = state.currentLevel;
    document.getElementById('badgeCount').textContent = state.badges.length;
    document.getElementById('completedCount').textContent = state.completedLevels.length;

    // Update health
    const healthContainer = document.getElementById('healthContainer');
    for (let i = 0; i < state.maxHealth; i++) {
      const heart = document.createElement('span');
      heart.className = i < state.health ? 'heart full' : 'heart empty';
      heart.textContent = '‚ô•';
      healthContainer.appendChild(heart);
    }

    // Update XP bar
    const progress = gameState.getLevelProgress();
    document.getElementById('xpProgress').textContent = `${progress.current} / ${progress.required} XP`;
    document.getElementById('xpFill').style.width = `${progress.percentage}%`;
    document.getElementById('xpPercent').textContent = `${progress.percentage}%`;

    // Generate level buttons for World 1 (Levels 1-15)
    const levelGrid = document.getElementById('levelGrid');
    
    for (let i = 1; i <= 15; i++) { // All 15 levels in World 1
      const levelBtn = document.createElement('button');
      levelBtn.className = 'pixel-button';
      
      const isCompleted = state.completedLevels.includes(i);
      const isUnlocked = gameState.isLevelUnlocked(i);
      const isCurrent = i === state.completedLevels.length + 1;
      const isBoss = i === 15; // Boss fight!
      
      if (isCompleted) {
        levelBtn.style.background = 'var(--pixel-primary)';
        levelBtn.innerHTML = `
          ‚úì LEVEL ${i}<br>
          <span style="font-size: 10px;">COMPLETE</span>
        `;
      } else if (isCurrent && isBoss) {
        levelBtn.style.background = 'var(--pixel-danger)';
        levelBtn.style.animation = 'pulse 1.5s ease-in-out infinite';
        levelBtn.innerHTML = `
          üêâ BOSS ${i}<br>
          <span style="font-size: 10px;">FIGHT NOW!</span>
        `;
      } else if (isCurrent) {
        levelBtn.style.background = 'var(--pixel-accent)';
        levelBtn.innerHTML = `
          ‚ñ∂ LEVEL ${i}<br>
          <span style="font-size: 10px;">PLAY NOW</span>
        `;
      } else if (isUnlocked && isBoss) {
        levelBtn.style.background = 'var(--pixel-danger)';
        levelBtn.innerHTML = `
          üêâ BOSS ${i}<br>
          <span style="font-size: 10px;">UNLOCKED</span>
        `;
      } else if (isUnlocked) {
        levelBtn.style.background = 'var(--pixel-secondary)';
        levelBtn.innerHTML = `
          LEVEL ${i}<br>
          <span style="font-size: 10px;">UNLOCKED</span>
        `;
      } else if (isBoss) {
        levelBtn.style.background = 'var(--pixel-border)';
        levelBtn.style.cursor = 'not-allowed';
        levelBtn.innerHTML = `
          üêâ BOSS ${i}<br>
          <span style="font-size: 10px;">LOCKED</span>
        `;
      } else {
        levelBtn.style.background = 'var(--pixel-border)';
        levelBtn.style.cursor = 'not-allowed';
        levelBtn.innerHTML = `
          üîí LEVEL ${i}<br>
          <span style="font-size: 10px;">LOCKED</span>
        `;
      }
      
      levelBtn.style.padding = '16px';
      levelBtn.style.fontSize = '12px';
      levelBtn.style.lineHeight = '1.5';
      
      if (isUnlocked) {
        levelBtn.addEventListener('click', () => {
          window.location.href = `/mission/${i}`;
        });
      }
      
      levelGrid.appendChild(levelBtn);
    }

    // Skill World modal logic: fetch all level metadata and group by world
    const skillBtn = document.getElementById('skillWorldBtn');
    const skillModal = document.getElementById('skillWorldModal');
    const closeSkill = document.getElementById('closeSkillModal');
    const skillContent = document.getElementById('skillWorldContent');

    let cachedWorlds = null;

    // Render list of worlds (click to open world overview)
    function renderWorldList(worlds) {
      skillContent.innerHTML = '';
      const grid = document.createElement('div');
      grid.style.display = 'grid';
      grid.style.gridTemplateColumns = 'repeat(auto-fit, minmax(220px, 1fr))';
      grid.style.gap = '12px';

      Object.keys(worlds).sort((a,b)=>a-b).forEach(wid => {
        const list = worlds[wid];
        const worldCard = document.createElement('div');
        worldCard.className = 'pixel-card';
        worldCard.style.padding = '12px';
        worldCard.style.cursor = 'pointer';
        worldCard.innerHTML = `
          <div style="font-weight:800; font-family:var(--font-pixel);">WORLD ${wid.toUpperCase ? wid.toUpperCase() : wid}</div>
          <div style="margin-top:6px; color:var(--pixel-text-dim);">${(list[0] && list[0].world) ? list[0].world.replace(/-/g,' ').toUpperCase() : 'Unknown Region'}</div>
          <div style="margin-top:8px; font-size:13px;">Levels: ${list.length}</div>
        `;

        worldCard.addEventListener('click', () => renderWorldOverview(wid, worlds[wid]));
        grid.appendChild(worldCard);
      });

      skillContent.appendChild(grid);
    }

    // Render overview for a specific world (read-only)
    function renderWorldOverview(wid, list) {
      skillContent.innerHTML = '';

      const header = document.createElement('div');
      header.style.display = 'flex';
      header.style.justifyContent = 'space-between';
      header.style.alignItems = 'center';
      header.style.marginBottom = '12px';

      const title = document.createElement('div');
      title.innerHTML = `<strong>WORLD ${wid}</strong> ‚Äî ${(list[0] && list[0].world) ? list[0].world.replace(/-/g,' ').toUpperCase() : ''}`;
      header.appendChild(title);

      const backBtn = document.createElement('button');
      backBtn.className = 'pixel-button';
      backBtn.textContent = 'Back';
      backBtn.addEventListener('click', () => renderWorldList(cachedWorlds));
      header.appendChild(backBtn);

      skillContent.appendChild(header);

      const ul = document.createElement('div');
      ul.style.display = 'grid';
      ul.style.gridTemplateColumns = 'repeat(auto-fit, minmax(220px, 1fr))';
      ul.style.gap = '8px';

      list.forEach(lv => {
        const card = document.createElement('div');
        card.style.background = 'var(--pixel-surface)';
        card.style.border = '2px solid var(--pixel-border)';
        card.style.padding = '8px';
        card.style.fontSize = '13px';
        card.innerHTML = `
          <div style="font-weight:700; margin-bottom:6px;">LEVEL ${lv.id}: ${lv.title}</div>
          <div style="color:var(--pixel-text-dim); font-size:12px; max-height:72px; overflow:hidden;">${lv.story || lv.instructions || ''}</div>
          <div style="margin-top:8px; font-size:11px; color:var(--pixel-text-dim);">Difficulty: ${lv.difficulty || 'unknown'}</div>
        `;

        ul.appendChild(card);
      });

      skillContent.appendChild(ul);
    }

    skillBtn.addEventListener('click', async () => {
      skillModal.style.display = 'flex';
      skillContent.innerHTML = '<p style="color:var(--pixel-text-dim);">Loading worlds...</p>';

      if (!cachedWorlds) {
        // Try to load up to 100 level files; push successes
        const levels = [];
        let consecutiveFailures = 0;
        for (let i = 1; i <= 100; i++) {
          const id = String(i).padStart(3, '0');
          try {
            const res = await fetch(`/missions/level-${id}.json`);
            if (!res.ok) {
              consecutiveFailures++;
              if (consecutiveFailures >= 5) break; // Stop after 5 consecutive 404s
              continue;
            }
            consecutiveFailures = 0; // Reset counter on success
            const json = await res.json();
            levels.push(json);
          } catch (e) {
            // ignore fetch errors
          }
        }

        if (levels.length === 0) {
          skillContent.innerHTML = '<p style="color:var(--pixel-text-dim);">No worlds found.</p>';
          return;
        }

        // Group by worldId and sort
        const worlds = {};
        levels.sort((a, b) => a.id - b.id);
        levels.forEach(lv => {
          const wid = lv.worldId || Math.ceil(lv.id / 15);
          if (!worlds[wid]) worlds[wid] = [];
          worlds[wid].push(lv);
        });

        cachedWorlds = worlds;
      }

      renderWorldList(cachedWorlds);
    });

    closeSkill.addEventListener('click', () => {
      skillModal.style.display = 'none';
    });
  </script>
</BaseLayout>
